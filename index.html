<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인스타그램 다운로더</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 추가된 스타일 */
        .blur-backdrop {
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        .caption-content {
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;  
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .caption-content.expanded {
            display: block;
            -webkit-line-clamp: unset;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    {% raw %}
    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [url, setUrl] = useState('');
            const [loading, setLoading] = useState(false);
            const [downloadingAll, setDownloadingAll] = useState(false);
            const [media, setMedia] = useState([]);
            const [error, setError] = useState('');
            const [postInfo, setPostInfo] = useState(null);
            const [isCaptionExpanded, setIsCaptionExpanded] = useState(false);

            const API_URL = '/api';

            const handleExtract = async () => {
                setError('');
                setMedia([]);
                setPostInfo(null);
                setIsCaptionExpanded(false);
                
                if (!url.trim()) {
                    setError('URL을 입력해주세요.');
                    return;
                }

                setLoading(true);

                try {
                    const response = await fetch(`${API_URL}/extract`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url }),
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || '추출 중 오류가 발생했습니다.');
                    }
                    setMedia(data.media);
                    setPostInfo({
                        postId: data.post_id,
                        caption: data.caption,
                        hashtags: data.hashtags,
                        mediaCount: data.media_count
                    });
                } catch (err) {
                    setError(err.message || '서버와 연결할 수 없습니다. 서버 상태를 확인해주세요.');
                } finally {
                    setLoading(false);
                }
            };

            const handleDownload = async (mediaItem) => {
                if (!postInfo) return;
                try {
                    const response = await fetch(`${API_URL}/download`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            url: mediaItem.type === 'video' ? mediaItem.video_url : mediaItem.url,
                            shortcode: postInfo.postId,
                            index: mediaItem.index
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '다운로드 실패');
                    }

                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = downloadUrl;
                    
                    const fileExtension = (mediaItem.type === 'video' ? '.mp4' : '.jpg');
                    a.download = `instagram_${postInfo.postId}_${mediaItem.index + 1}${fileExtension}`;
                    
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(downloadUrl);
                    a.remove();
                } catch (err) {
                    alert('다운로드 중 오류가 발생했습니다: ' + err.message);
                }
            };

            const handleDownloadAll = async () => {
                if (!postInfo) return;
                setDownloadingAll(true);
                try {
                    const response = await fetch(`${API_URL}/download_all`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url }),
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '전체 다운로드 실패');
                    }
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = downloadUrl;
                    a.download = `instagram_${postInfo.postId}_all.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(downloadUrl);
                    a.remove();
                } catch (err) {
                    alert('전체 다운로드 중 오류가 발생했습니다: ' + err.message);
                } finally {
                    setDownloadingAll(false);
                }
            };

            const Caption = ({ text }) => {
                if (!text) return null;
                const needsTruncation = text.split('\n').length > 5 || text.length > 300;
                return (
                    <div>
                        <p className={`caption-content ${isCaptionExpanded ? 'expanded' : ''} whitespace-pre-wrap`}>
                            {text}
                        </p>
                        {needsTruncation && (
                            <button 
                                onClick={() => setIsCaptionExpanded(!isCaptionExpanded)} 
                                className="text-blue-600 hover:underline mt-2 text-sm font-semibold"
                            >
                                {isCaptionExpanded ? '간략히' : '...더보기'}
                            </button>
                        )}
                    </div>
                );
            };

            return (
                <div className="min-h-screen p-4 sm:p-8 flex items-center justify-center">
                    {downloadingAll && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 blur-backdrop flex items-center justify-center z-50">
                            <div className="text-center text-white p-8 bg-gray-800 bg-opacity-80 rounded-2xl shadow-lg">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
                                <p className="text-lg font-semibold">ZIP 파일 다운로드 중...</p>
                                <p className="text-sm">잠시만 기다려 주세요.</p>
                            </div>
                        </div>
                    )}
                    <div className="w-full max-w-4xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
                            <div className="text-center mb-8">
                                <div className="inline-block p-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full mb-4">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                                </div>
                                <h1 className="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">
                                    인스타그램 미디어 다운로더
                                </h1>
                                <p className="text-gray-600">게시물 URL을 입력하면 이미지와 영상을 추출합니다.</p>
                            </div>

                            <div className="mb-6">
                                <div className="flex flex-col sm:flex-row gap-2">
                                    <input
                                        type="text" value={url} onChange={(e) => setUrl(e.target.value)}
                                        placeholder="https://www.instagram.com/p/..."
                                        className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition"
                                        onKeyPress={(e) => e.key === 'Enter' && handleExtract()}
                                    />
                                    <button
                                        onClick={handleExtract} disabled={loading}
                                        className="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        {loading ? (
                                            <>
                                                <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                                                <span>추출 중...</span>
                                            </>
                                        ) : '추출하기'}
                                    </button>
                                </div>
                            </div>
                            
                            {error && <div className="mb-6 p-4 bg-red-50 text-red-800 border border-red-200 rounded-lg">{error}</div>}
                            
                            {postInfo && (
                                <div className="space-y-4 mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <p className="font-bold text-green-900">✅ 추출 완료!</p>
                                    <div className="text-green-800 text-sm">
                                        <Caption text={postInfo.caption} />
                                    </div>
                                    {postInfo.hashtags && postInfo.hashtags.length > 0 && (
                                        <div className="flex flex-wrap gap-2 pt-2">
                                            {postInfo.hashtags.map(tag => (
                                                <span key={tag} className="px-3 py-1 bg-green-100 text-green-900 text-xs font-semibold rounded-full">
                                                    #{tag}
                                                </span>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                            {media.length > 0 && (
                                <div>
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-semibold text-gray-800">추출된 미디어 ({media.length}개)</h2>
                                        <button onClick={handleDownloadAll} className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-all flex items-center gap-2 text-sm">
                                            <span>전체 다운로드 (ZIP)</span>
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                        {media.map((item) => (
                                            <div key={item.index} className="group relative bg-gray-100 rounded-lg overflow-hidden aspect-square shadow">
                                                {item.type === 'video' ? (
                                                    <video
                                                        src={`${API_URL}/proxy?url=${encodeURIComponent(item.video_url || item.url)}`}
                                                        className="w-full h-full object-cover"
                                                        playsInline muted preload="metadata"
                                                    />
                                                ) : (
                                                    <img src={`${API_URL}/proxy?url=${encodeURIComponent(item.url)}`} className="w-full h-full object-cover" />
                                                )}
                                                <div className="absolute top-2 left-2 px-2 py-1 bg-black bg-opacity-60 text-white text-xs rounded-full">{item.type === 'video' ? '영상' : '이미지'}</div>
                                                {item.type === 'video' && (
                                                    <div id="play-icon" className="absolute inset-0 flex items-center justify-center text-white opacity-80 group-hover:opacity-100 transition-opacity pointer-events-none">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" style={{filter: 'drop-shadow(0px 0px 4px rgba(0,0,0,0.7))'}}><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg>
                                                    </div>
                                                )}
                                                <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all flex items-center justify-center">
                                                    <button onClick={() => handleDownload(item)} className="opacity-0 group-hover:opacity-100 transition-all px-4 py-2 bg-white text-gray-800 rounded-lg font-semibold flex items-center gap-2 text-sm">
                                                        <span>다운로드</span>
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
    {% endraw %}
</body>
</html>

