<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인스타그램 미디어 다운로더</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .blur-background {
            filter: blur(4px);
            transition: filter 0.3s ease-out;
        }
        .no-blur {
            filter: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function App() {
            const [url, setUrl] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [isDownloadingAll, setIsDownloadingAll] = React.useState(false);
            const [media, setMedia] = React.useState([]);
            const [error, setError] = React.useState('');
            const [postInfo, setPostInfo] = React.useState(null);
            const [isExpanded, setIsExpanded] = React.useState(false);

            // ★★★ 가장 중요한 변경사항 ★★★
            // API 주소를 상대 경로로 변경하여, 현재 서비스되는 서버에 요청하도록 합니다.
            const API_URL = '/api';

            const handleExtract = async () => {
                setError('');
                setMedia([]);
                setPostInfo(null);
                
                if (!url.trim()) {
                    setError('URL을 입력해주세요.');
                    return;
                }

                setLoading(true);

                try {
                    const response = await fetch(`${API_URL}/extract`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url }),
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || '추출 중 오류가 발생했습니다.');
                    }

                    setMedia(data.media);
                    setPostInfo({
                        postId: data.post_id,
                        caption: data.caption,
                        hashtags: data.hashtags || [],
                        mediaCount: data.media_count
                    });
                    
                } catch (err) {
                    setError(err.message || '서버와 연결할 수 없습니다. 서버가 실행 중인지 확인해주세요.');
                } finally {
                    setLoading(false);
                }
            };

            const handleDownload = async (item) => {
                if (!postInfo) return;

                // 영상일 경우 video_url 사용, 아닐 경우 썸네일 url 사용
                const downloadUrl = item.type === 'video' ? item.video_url : item.url;
                
                try {
                    const response = await fetch(`${API_URL}/download`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            url: downloadUrl,
                            shortcode: postInfo.postId,
                            index: item.index
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '다운로드 실패');
                    }
                    
                    const blob = await response.blob();
                    const contentDisposition = response.headers.get('content-disposition');
                    let filename = `instagram_${postInfo.postId}_${item.index + 1}.jpg`; // 기본 파일명
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                        if (filenameMatch.length > 1) {
                            filename = filenameMatch[1];
                        }
                    }

                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(link.href);
                    
                } catch (err) {
                    alert('다운로드 중 오류가 발생했습니다: ' + err.message);
                }
            };

            const handleDownloadAll = async () => {
                if (!postInfo) return;
                setIsDownloadingAll(true);

                try {
                    const response = await fetch(`${API_URL}/download_all`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '전체 다운로드 실패');
                    }

                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `instagram_${postInfo.postId}_all.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                    
                } catch (err) {
                    alert('전체 다운로드 중 오류가 발생했습니다: ' + err.message);
                } finally {
                    setIsDownloadingAll(false);
                }
            };

            const captionLines = postInfo?.caption.split('\n') || [];
            const showMoreButton = captionLines.length > 5;

            return (
                <div className={isDownloadingAll ? 'blur-background' : 'no-blur'}>
                    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-orange-50 p-4 sm:p-8">
                        <div className="max-w-4xl mx-auto">
                            <div className="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                                <div className="text-center mb-8">
                                    <h1 className="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">
                                        인스타그램 미디어 다운로더
                                    </h1>
                                    <p className="text-gray-600">게시물 URL을 입력하면 이미지와 영상을 추출합니다</p>
                                </div>

                                <div className="mb-6">
                                    <div className="flex flex-col sm:flex-row gap-2">
                                        <input
                                            type="text"
                                            value={url}
                                            onChange={(e) => setUrl(e.target.value)}
                                            placeholder="https://www.instagram.com/p/..."
                                            className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                                            onKeyPress={(e) => e.key === 'Enter' && handleExtract()}
                                        />
                                        <button
                                            onClick={handleExtract}
                                            disabled={loading}
                                            className="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-medium hover:from-purple-700 hover:to-pink-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                        >
                                            {loading ? '추출 중...' : '추출하기'}
                                        </button>
                                    </div>
                                </div>

                                {error && <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">{error}</div>}

                                {postInfo && (
                                    <div className="space-y-4">
                                        <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                                            <p className="font-semibold text-green-800">추출 완료!</p>
                                        </div>
                                        
                                        {postInfo.caption && (
                                            <div className="p-4 border rounded-lg">
                                                <p className="font-semibold mb-2">본문</p>
                                                <div className="text-gray-700 whitespace-pre-wrap text-sm">
                                                    {isExpanded ? captionLines.join('\n') : captionLines.slice(0, 5).join('\n')}
                                                    {showMoreButton && (
                                                         <button onClick={() => setIsExpanded(!isExpanded)} className="text-blue-600 font-semibold ml-2">
                                                            {isExpanded ? '...접기' : '...더보기'}
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {postInfo.hashtags.length > 0 && (
                                            <div className="p-4 border rounded-lg">
                                                <p className="font-semibold mb-2">해시태그</p>
                                                <div className="flex flex-wrap gap-2">
                                                    {postInfo.hashtags.map(tag => (
                                                        <span key={tag} className="px-3 py-1 bg-gray-200 text-gray-800 rounded-full text-sm">#{tag}</span>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {media.length > 0 && (
                                    <div className="mt-6">
                                        <div className="flex items-center justify-between mb-4">
                                            <h2 className="text-xl font-semibold text-gray-800">추출된 미디어 ({media.length}개)</h2>
                                            <button
                                                onClick={handleDownloadAll}
                                                className="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-all"
                                            >
                                                전체 다운로드 (ZIP)
                                            </button>
                                        </div>

                                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                            {media.map(item => (
                                                <div key={item.index} className="group relative bg-gray-100 rounded-lg overflow-hidden aspect-square">
                                                    {item.type === 'image' ? (
                                                         <img src={`${API_URL}/proxy?url=${encodeURIComponent(item.url)}`} className="w-full h-full object-cover" />
                                                    ) : (
                                                        <video src={`${API_URL}/proxy?url=${encodeURIComponent(item.url)}`} className="w-full h-full object-cover" muted playsInline />
                                                    )}
                                                    <div className="absolute top-2 left-2 px-2 py-1 bg-black bg-opacity-70 text-white text-xs rounded-full">
                                                        {item.type === 'video' ? '영상' : '이미지'}
                                                    </div>
                                                    {item.type === 'video' && (
                                                        <div className="absolute inset-0 flex items-center justify-center text-white">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" style={{filter: 'drop-shadow(0px 0px 4px rgba(0,0,0,0.7))'}}><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg>
                                                        </div>
                                                    )}
                                                    <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all flex items-center justify-center">
                                                        <button
                                                            onClick={() => handleDownload(item)}
                                                            className="opacity-0 group-hover:opacity-100 transition-all px-4 py-2 bg-white text-gray-800 rounded-lg font-medium"
                                                        >
                                                            다운로드
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {isDownloadingAll && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg flex flex-col items-center gap-4">
                                <p className="font-semibold text-lg">ZIP 파일 다운로드 중...</p>
                                <p className="text-sm text-gray-600">완료될 때까지 잠시만 기다려주세요.</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

